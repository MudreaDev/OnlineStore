@model OnlineStore.Domain.Entities.Product
@using OnlineStore.Domain.Entities

@{
    ViewData["Title"] = "Edit Product";
}

<style>
    .admin-form-container {
        max-width: 800px;
        margin: 0 auto;
        padding-top: 2rem;
        margin-bottom: 5rem;
    }

    .auth-card {
        background: #fff;
        border: 1px solid var(--border-light);
        border-radius: 30px;
        padding: 3rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
    }

    .form-label {
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-input {
        width: 100%;
        background: var(--bg-warm);
        border: 1.5px solid transparent;
        border-radius: 12px;
        padding: 0.8rem 1.25rem;
        font-family: var(--font-main);
        transition: var(--transition);
        outline: none;
    }

    .form-input:focus {
        background: #fff;
        border-color: var(--accent-green);
        box-shadow: 0 0 0 4px rgba(45, 106, 79, 0.1);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Image Management */
    .image-management-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-light);
    }

    .existing-images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .image-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--border-light);
        transition: var(--transition);
    }

    .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-item.marked-for-deletion {
        opacity: 0.4;
        filter: grayscale(1);
    }

    .image-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: var(--transition);
    }

    .image-item:hover .image-overlay {
        opacity: 1;
    }

    .btn-delete-img {
        background: #fff;
        color: #a4161a;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
    }

    .deletion-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #a4161a;
        color: #fff;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
    }

    .main-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--accent-green);
        color: #fff;
        font-size: 0.6rem;
        font-weight: 800;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
        z-index: 2;
    }

    .upload-zone {
        border: 2px dashed var(--border-light);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        background: #fafafa;
        transition: var(--transition);
    }

    .upload-zone:hover {
        border-color: var(--accent-green);
        background: #fdfdfb;
    }

    .btn-submit {
        background: var(--text-dark);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 1.25rem;
        font-weight: 700;
        cursor: pointer;
        width: 100%;
        margin-top: 3rem;
        transition: var(--transition);
    }

    .btn-submit:hover {
        background: var(--accent-green);
        transform: translateY(-2px);
    }
</style>

<div class="admin-form-container">
    <h1 class="display-title" style="font-family: var(--font-serif); font-size: 2.5rem; margin-bottom: 0.5rem;">Edit
        <span class="highlight">Product</span></h1>
    <p class="subtitle mb-5" style="color: var(--text-muted);">Refine product details and manage selection images.</p>

    <div class="auth-card">
        <form asp-action="EditProduct" method="post" enctype="multipart/form-data" id="editForm">
            <input type="hidden" name="id" value="@Model.Id" />

            <div class="form-grid">
                <div class="form-group">
                    <label for="Name" class="form-label">Name</label>
                    <input type="text" name="Name" id="Name" value="@Model.Name" class="form-input" required />
                </div>
                <div class="form-group">
                    <label for="Price" class="form-label">Price</label>
                    <input type="number" name="Price" id="Price" value="@Model.Price" step="0.01" class="form-input"
                        required />
                </div>
            </div>

            @if (Model is ElectronicProduct electronic)
            {
                <div class="form-group mb-4">
                    <label for="WarrantyMonths" class="form-label">Warranty (Months)</label>
                    <input type="number" name="WarrantyMonths" id="WarrantyMonths" value="@electronic.WarrantyMonths"
                        class="form-input" />
                </div>
            }
            else if (Model is ClothingProduct clothing)
            {
                <div class="form-grid">
                    <div class="form-group">
                        <label for="Size" class="form-label">Size</label>
                        <input type="text" name="Size" id="Size" value="@clothing.Size" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label for="Material" class="form-label">Material</label>
                        <input type="text" name="Material" id="Material" value="@clothing.Material" class="form-input" />
                    </div>
                </div>
            }
            else if (Model is VehicleProduct vehicle)
            {
                <div class="form-grid">
                    <div class="form-group">
                        <label for="Brand" class="form-label">Brand</label>
                        <input type="text" name="Brand" id="Brand" value="@vehicle.Brand" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label for="Model" class="form-label">Model</label>
                        <input type="text" name="Model" id="Model" value="@vehicle.Model" class="form-input" />
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label for="Year" class="form-label">Year</label>
                    <input type="number" name="Year" id="Year" value="@vehicle.Year" class="form-input" />
                </div>
            }

            <div class="image-management-section">
                <h3 class="form-label" style="margin-bottom: 1.5rem;">Collection Images (@Model.Images.Count/5)</h3>

                @if (Model.Images.Any())
                {
                    <div class="existing-images-grid">
                        @foreach (var img in Model.Images.OrderBy(i => i.DisplayOrder))
                        {
                            <div class="image-item" id="img-@img.PublicId.Replace("/", "-").Replace(".", "-")">
                                <img src="@img.ImageUrl" alt="Product Image">
                                @if (img.IsMain)
                                {
                                    <span class="main-badge">Main</span>
                                }
                                <div class="image-overlay">
                                    <button type="button" class="btn-delete-img"
                                        onclick="toggleImageDeletion('@img.PublicId')">Ã—</button>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (Model.Images.Count < 5)
                {
                    <div class="upload-zone" onclick="document.getElementById('newImagesInp').click()">
                        <p style="font-weight: 700; font-size: 0.9rem;">+ Add New Images</p>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Up to @(5 -
                        Model.Images.Count) more</p>
                    </div>
                    <input type="file" name="newImages" id="newImagesInp" multiple accept=".jpg,.jpeg,.png,.webp"
                        style="display:none" onchange="previewNewImages(this)" />
                    <div id="newImagesPreview" class="existing-images-grid" style="margin-top: 1.5rem;"></div>
                }
            </div>

            <div id="deletionInputs"></div>

            <button type="submit" class="btn-submit">Sync Update to Collection</button>
        </form>
    </div>
</div>

<script>
    const deletedPublicIds = new Set();

    function toggleImageDeletion(publicId) {
        const safeId = 'img-' + publicId.replace(/\//g, '-').replace(/\./g, '-');
        const element = document.getElementById(safeId);

        if (deletedPublicIds.has(publicId)) {
            deletedPublicIds.delete(publicId);
            element.classList.remove('marked-for-deletion');
            const indicator = element.querySelector('.deletion-indicator');
            if (indicator) indicator.remove();
        } else {
            deletedPublicIds.add(publicId);
            element.classList.add('marked-for-deletion');
            const indicator = document.createElement('div');
            indicator.className = 'deletion-indicator';
            indicator.innerText = 'To Delete';
            element.appendChild(indicator);
        }

        updateDeletionInputs();
    }

    function updateDeletionInputs() {
        const container = document.getElementById('deletionInputs');
        container.innerHTML = '';
        deletedPublicIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'deletePublicIds';
            input.value = id;
            container.appendChild(input);
        });
    }

    function previewNewImages(input) {
        const preview = document.getElementById('newImagesPreview');
        preview.innerHTML = '';
        const files = Array.from(input.files);

        const existingCount = @Model.Images.Count;
        const total = (existingCount - deletedPublicIds.size) + files.length;

        if (total > 5) {
            alert('A maximum of 5 images is allowed per product.');
            input.value = '';
            return;
        }

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.innerHTML = `<img src="${e.target.result}" style="border: 2px solid var(--accent-green)">`;
                preview.appendChild(item);
            }
            reader.readAsDataURL(file);
        });
    }
</script>
