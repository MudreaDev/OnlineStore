@model OnlineStore.WebUI.Models.CartViewModel
@using OnlineStore.Domain.Singleton

@{
    ViewData["Title"] = "Your Selection";
    var cartItems = ViewBag.CartItems as List<(OnlineStore.Domain.Entities.Product Product, int Quantity)>;
    decimal total = ViewBag.Total ?? 0;
    decimal freeShippingThreshold = ApplicationConfigurationManager.Instance.FreeShippingThreshold;
}

<style>
    .cart-page {
        padding-top: 3rem;
        padding-bottom: 8rem;
    }

    .cart-layout {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 5rem;
        align-items: start;
    }

    .cart-title {
        font-family: var(--font-elegant);
        font-size: 3rem;
        color: var(--midnight);
        margin-bottom: 3rem;
        grid-column: span 2;
        letter-spacing: -0.02em;
    }

    /* --- Cart Items --- */
    .cart-items-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .cart-item-luxury {
        display: grid;
        grid-template-columns: 100px 1fr auto;
        gap: 2rem;
        background: #fff;
        border: 1px solid var(--border-subtle);
        border-radius: 20px;
        padding: 1.5rem;
        align-items: center;
        transition: var(--transition-smooth);
    }

    .cart-item-luxury:hover {
        border-color: var(--accent-primary);
        box-shadow: var(--shadow-md);
    }

    .item-visual {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        background: #fdfdfb;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .item-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-emoji { font-size: 2.5rem; }

    .item-info h4 {
        font-family: var(--font-display);
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--midnight);
        margin-bottom: 0.25rem;
    }

    .item-info .item-cat {
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        color: var(--accent-primary);
        letter-spacing: 0.1em;
    }

    .item-controls {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .qty-wrap {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--bg-base);
        padding: 0.4rem 0.75rem;
        border-radius: 10px;
        font-weight: 700;
    }

    .qty-btn {
        background: none;
        border: none;
        color: var(--midnight);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0 0.25rem;
        transition: color 0.2s;
    }

    .qty-btn:hover { color: var(--accent-primary); }

    .item-price {
        font-family: var(--font-display);
        font-weight: 700;
        font-size: 1.125rem;
        color: var(--midnight);
        min-width: 80px;
        text-align: right;
    }

    .remove-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 10px;
        transition: var(--transition-smooth);
    }

    .remove-btn:hover {
        background: #fee2e2;
        color: #ef4444;
    }

    /* --- Sticky Summary --- */
    .summary-glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: 24px;
        padding: 2rem;
        position: sticky;
        top: 100px;
        box-shadow: var(--shadow-lg);
    }

    .summary-title {
        font-family: var(--font-display);
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--midnight);
        margin-bottom: 2rem;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .summary-total {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        font-family: var(--font-display);
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--midnight);
    }

    .btn-checkout {
        display: block;
        width: 100%;
        background: var(--midnight);
        color: #fff;
        text-align: center;
        padding: 1.25rem;
        border-radius: 16px;
        margin-top: 2rem;
        font-family: var(--font-display);
        font-weight: 700;
        text-decoration: none;
        transition: var(--transition-smooth);
    }

    .btn-checkout:hover {
        background: var(--accent-primary);
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(5, 150, 105, 0.2);
    }

    .shipping-notice {
        margin-top: 1.5rem;
        font-size: 0.75rem;
        color: var(--text-muted);
        text-align: center;
        line-height: 1.6;
    }

    .empty-state {
        text-align: center;
        padding: 10rem 0;
        grid-column: span 2;
    }

    @@media (max-width: 900px) {
        .cart-layout { grid-template-columns: 1fr; gap: 3rem; }
        .summary-glass { position: static; }
    }
</style>

<div class="container cart-page fade-in">
    <div class="cart-layout">
        <h1 class="cart-title">Your Selection</h1>

        @if (cartItems == null || !cartItems.Any())
        {
            <div class="empty-state">
                <div style="font-size: 4rem; opacity: 0.2; margin-bottom: 2rem;">ðŸ§³</div>
                <h3 style="font-family: var(--font-elegant); font-size: 2rem; color: var(--midnight);">Your bag is empty</h3>
                <p style="color: var(--text-muted); margin-bottom: 2.5rem;">Explore our collection to find your next essential pieces.</p>
                <a asp-controller="Home" asp-action="Index" class="btn-checkout" style="display: inline-block; width: auto; padding: 1rem 3rem;">Shop Collection</a>
            </div>
        }
        else
        {
            <div class="cart-items-list">
                @foreach (var item in cartItems)
                {
                    var product = item.Product;
                    var typeName = product.GetType().Name.Replace("Product", "");
                    var mainImage = product.Images.FirstOrDefault(i => i.IsMain) ?? product.Images.FirstOrDefault();
                    var emoji = typeName switch {
                        "Electronic" => "ðŸ”Œ",
                        "Clothing" => "ðŸ‘•",
                        "Vehicle" => "ðŸš—",
                        _ => "ðŸ“¦"
                    };

                    <div class="cart-item-luxury">
                        <div class="item-visual">
                            @if (mainImage != null)
                            {
                                <img src="@mainImage.ImageUrl" class="item-img" alt="@product.Name">
                            }
                            else
                            {
                                <span class="item-emoji">@emoji</span>
                            }
                        </div>

                        <div class="item-info">
                            <span class="item-cat">Handcrafted @typeName</span>
                            <h4>@product.Name</h4>
                            <p style="font-size: 0.75rem; color: var(--text-muted);">Status: Ready for shipment</p>
                        </div>

                        <div class="item-controls">
                            <div class="qty-wrap">
                                <form asp-action="UpdateQuantity" method="post" style="display: inline">
                                    <input type="hidden" name="id" value="@product.Id" />
                                    <input type="hidden" name="quantity" value="@(item.Quantity - 1)" />
                                    <button type="submit" class="qty-btn" @(item.Quantity <= 1 ? "disabled" : "")>âˆ’</button>
                                </form>
                                <span>@item.Quantity</span>
                                <form asp-action="UpdateQuantity" method="post" style="display: inline">
                                    <input type="hidden" name="id" value="@product.Id" />
                                    <input type="hidden" name="quantity" value="@(item.Quantity + 1)" />
                                    <button type="submit" class="qty-btn">+</button>
                                </form>
                            </div>

                            <div class="item-price">@((product.Price * item.Quantity).ToString("C0"))</div>

                            <form asp-action="Remove" method="post">
                                <input type="hidden" name="id" value="@product.Id" />
                                <button type="submit" class="remove-btn" title="Remove from selection">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                }
            </div>

            <aside class="summary-glass">
                <h3 class="summary-title">Order Summary</h3>
                
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span>@total.ToString("C2")</span>
                </div>
                
                <div class="summary-row">
                    <span>Shipping</span>
                    <span>@(total >= freeShippingThreshold ? "Complimentary" : "â‚¬15.00")</span>
                </div>

                @if (total < freeShippingThreshold)
                {
                    <div style="background: rgba(5, 150, 105, 0.05); padding: 0.75rem; border-radius: 12px; font-size: 0.7rem; color: var(--accent-primary); font-weight: 700; margin-bottom: 2rem; border: 1px solid rgba(5, 150, 105, 0.1);">
                        Add @((freeShippingThreshold - total).ToString("C2")) for Complimentary Shipping
                    </div>
                }

                <div class="summary-total">
                    <span>Total</span>
                    <span>@((total >= freeShippingThreshold ? total : total + 15).ToString("C2"))</span>
                </div>

                <a asp-action="Checkout" class="btn-checkout">Proceed to Checkout</a>
                
                <div class="shipping-notice">
                    Orders are processed within 24 hours. Free returns within 30 days for premium members.
                </div>
            </aside>
        }
    </div>
</div>
